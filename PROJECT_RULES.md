# 项目规则体系

## 1. 项目概述

### 1.1 项目背景
本项目是一个基于深度学习的MCI（轻度认知障碍）恢复预测系统，用于预测MCI患者是否会恢复为认知正常（CN）。项目使用Python作为主要开发语言，涉及医学图像处理、深度学习、特征提取和分类算法等技术领域。

### 1.2 技术栈
- **主要语言**: Python 3.8+
- **深度学习框架**: PyTorch 1.9+
- **医学图像处理**: nibabel, scipy.ndimage
- **机器学习算法**: scikit-learn, XGBoost
- **版本控制**: Git
- **文档工具**: Markdown, Jupyter Notebook

### 1.3 团队规模
小型到中型开发团队（3-10人）

## 2. 代码规范

### 2.1 Python代码规范
- **遵循PEP 8标准**，使用4个空格缩进
- **行长度**：单行代码不超过100个字符
- **导入顺序**：标准库 → 第三方库 → 本地模块，每组导入之间空一行
- **类和函数定义**：类定义与其他代码之间空两行，函数定义之间空一行
- **注释**：使用清晰的单行注释（#）和文档字符串（docstring）

### 2.2 命名规范
- **变量和函数**：使用小写字母和下划线（snake_case），如`image_features`, `extract_text_features`
- **类名**：使用驼峰命名法（CamelCase），如`MCIDataLoader`, `FeatureExtractor`
- **常量**：使用全大写字母和下划线，如`RANDOM_SEED`, `RECOMMENDED_CONFIG`
- **模块名**：使用小写字母和下划线，如`data_utils.py`, `mci_recovery_prediction.py`

### 2.3 文档字符串规范
- 使用Google风格的文档字符串
- 类和函数必须包含文档字符串，说明其功能、参数和返回值
- 示例：
```python
def extract_image_features(self, images):
    """
    提取图像特征
    
    Args:
        images: 输入图像数据，形状为 [N, 3, D, H, W]
    
    Returns:
        提取的图像特征，形状为 [N, feature_dim]
    """
    pass
```

### 2.4 代码质量要求
- **避免重复代码**：相同功能的代码应封装为函数或类
- **保持函数简洁**：单个函数不应超过50行，复杂功能应拆分为多个函数
- **使用类型提示**：为函数参数和返回值添加类型提示
- **避免魔法数字**：将常量定义为有意义的变量名
- **处理异常**：合理使用try-except块，避免裸露的except语句

### 2.5 执行方式
- 使用`flake8`进行代码风格检查：`flake8 --max-line-length=100 --ignore=E203,W503`
- 使用`mypy`进行类型检查：`mypy --ignore-missing-imports --strict-optional`
- 开发过程中应实时使用IDE的代码检查功能

### 2.6 违规处理
- 轻微违规：代码审查时指出，开发者应在合并前修复
- 严重违规：要求开发者重新修改代码，直至符合规范
- 多次违规：团队内部通报批评

## 3. 开发流程

### 3.1 需求分析阶段
- **需求收集**：由产品经理或项目负责人收集和整理需求
- **需求评审**：团队成员共同评审需求，确保理解一致
- **需求文档**：编写详细的需求文档，包括功能描述、技术要求、验收标准等

### 3.2 设计阶段
- **架构设计**：确定系统架构、模块划分和技术选型
- **详细设计**：设计核心算法、类结构和接口
- **设计评审**：团队成员评审设计方案，提出改进建议

### 3.3 开发阶段
- **任务分配**：根据需求和设计文档，分配开发任务
- **代码开发**：遵循代码规范进行开发
- **单元测试**：为核心功能编写单元测试
- **集成测试**：测试模块之间的集成

### 3.4 测试阶段
- **功能测试**：测试所有功能是否符合需求
- **性能测试**：测试系统性能，如训练时间、预测速度等
- **稳定性测试**：测试系统在不同环境下的稳定性
- **测试报告**：编写测试报告，记录测试结果和发现的问题

### 3.5 部署阶段
- **环境配置**：配置生产环境，确保与开发环境一致
- **部署脚本**：编写自动化部署脚本
- **监控设置**：设置系统监控和日志收集

### 3.6 维护阶段
- **bug修复**：及时修复用户反馈的bug
- **功能迭代**：根据用户需求进行功能迭代
- **文档更新**：更新相关文档

## 4. 版本控制规则

### 4.1 Git分支管理
- **主分支（main）**：用于发布稳定版本，仅接受来自develop分支的合并
- **开发分支（develop）**：用于集成所有功能开发，接受来自feature分支的合并
- **功能分支（feature/*）**：用于开发新功能，命名格式为`feature/功能名称`，如`feature/mci_recovery_prediction`
- **修复分支（hotfix/*）**：用于修复生产环境的bug，命名格式为`hotfix/bug描述`，如`hotfix/fix_memory_leak`
- **发布分支（release/*）**：用于准备发布新版本，命名格式为`release/版本号`，如`release/v1.0.0`

### 4.2 分支操作规则
- **创建分支**：从develop分支创建feature分支，从main分支创建hotfix分支
- **合并分支**：使用Pull Request（PR）进行分支合并，禁止直接push到main和develop分支
- **删除分支**：功能完成并合并后，应删除对应的feature分支

### 4.3 提交信息格式
- **提交信息应包含三个部分**：标题、正文和脚注
- **标题格式**：`<类型>: <简短描述>`，如`feat: 添加MCI恢复预测功能`
- **提交类型**：
  - `feat`: 新功能
  - `fix`: 修复bug
  - `docs`: 文档更新
  - `style`: 代码风格修改
  - `refactor`: 代码重构
  - `test`: 添加或修改测试
  - `chore`: 构建过程或辅助工具的变动
- **示例**：
```
feat: 添加MCI恢复预测功能

- 实现MCIDataLoader类，用于加载MCI患者数据
- 实现FeatureExtractor类，用于提取多模态特征
- 实现MCIRecoveryClassifier类，用于训练和评估模型

Resolves #123
```

### 4.4 执行方式
- 使用`git-flow`工具辅助分支管理
- 提交前使用`git status`和`git diff`检查提交内容
- 定期使用`git pull`保持本地分支与远程分支同步

### 4.5 违规处理
- 不符合格式的提交信息：要求开发者修改提交信息
- 直接push到main或develop分支：团队内部通报批评，要求撤销并重新提交
- 长时间不合并的分支：提醒开发者尽快完成或关闭

## 5. 文档编写规范

### 5.1 文档类型
- **需求文档**：描述项目需求、功能和验收标准
- **设计文档**：描述系统架构、模块设计和接口定义
- **用户文档**：指导用户如何使用系统
- **开发文档**：指导开发者如何开发和维护系统
- **API文档**：描述系统的API接口

### 5.2 文档格式
- 使用Markdown格式编写文档
- 使用清晰的标题层级
- 包含目录，方便导航
- 使用图表说明复杂概念

### 5.3 文档更新
- 功能变更时，应同步更新相关文档
- 文档应与代码保持一致
- 定期审查文档，确保其准确性和完整性

### 5.4 执行方式
- 文档应存储在项目根目录的`docs/`文件夹中
- 重要文档应在README.md中链接
- 每次发布新版本时，应更新版本说明文档

### 5.5 违规处理
- 文档与代码不一致：要求开发者更新文档
- 缺少必要文档：要求开发者补充文档
- 文档质量差：要求开发者改进文档

## 6. 测试标准

### 6.1 测试类型
- **单元测试**：测试单个函数或类的功能
- **集成测试**：测试多个模块之间的交互
- **功能测试**：测试系统的功能是否符合需求
- **性能测试**：测试系统的性能指标
- **稳定性测试**：测试系统在长时间运行下的稳定性

### 6.2 测试覆盖率要求
- 核心功能的单元测试覆盖率不低于80%
- 使用`pytest-cov`工具进行覆盖率统计
- 测试代码应与生产代码分离，存放在`tests/`文件夹中

### 6.3 测试用例编写要求
- 测试用例应覆盖正常情况和异常情况
- 测试用例应具有可重复性
- 测试用例应包含清晰的断言
- 测试用例应使用有意义的名称

### 6.4 执行方式
- 使用`pytest`作为测试框架
- 每次提交代码前，应运行相关测试
- 合并分支前，应运行所有测试
- 集成到CI/CD流水线，自动运行测试

### 6.5 违规处理
- 未通过测试的代码：禁止合并到develop或main分支
- 缺少测试用例：要求开发者补充测试用例
- 测试覆盖率不达标：要求开发者提高测试覆盖率

## 7. 代码审查流程

### 7.1 审查范围
- 所有代码变更，包括新功能开发、bug修复、代码重构等
- 文档变更
- 配置文件变更

### 7.2 审查人员
- 每个Pull Request至少需要2名审查人员
- 审查人员应具备相关领域的专业知识
- 避免自己审查自己的代码

### 7.3 审查内容
- 代码是否符合规范
- 代码是否实现了预期功能
- 代码是否存在潜在的bug或性能问题
- 代码是否易于理解和维护
- 测试用例是否充分
- 文档是否完整

### 7.4 审查流程
1. 开发者创建Pull Request
2. 审查人员收到通知，开始审查
3. 审查人员提出修改意见
4. 开发者根据意见修改代码
5. 审查人员再次审查，确认修改
6. 审查通过后，合并Pull Request

### 7.5 审查时间要求
- 审查人员应在24小时内完成审查
- 复杂的Pull Request可延长至48小时
- 开发者应在24小时内处理审查意见

### 7.6 执行方式
- 使用GitHub或GitLab的Pull Request功能进行代码审查
- 审查意见应具体、明确，包含改进建议
- 审查通过的标准：至少2名审查人员批准，无未解决的意见

### 7.7 违规处理
- 未通过审查的代码：禁止合并
- 不及时处理审查意见：提醒开发者尽快处理
- 多次审查未通过：要求开发者重新设计和实现

## 8. 项目管理规则

### 8.1 任务管理
- 使用GitHub Issues或Jira进行任务管理
- 每个任务应包含清晰的描述、优先级和截止日期
- 任务状态应及时更新

### 8.2 会议规则
- 定期召开团队会议，讨论项目进展和问题
- 会议应提前准备议程
- 会议时间不宜过长，控制在30分钟以内
- 会议后应发送会议纪要

### 8.3 进度报告
- 开发者应每周更新工作进度
- 项目负责人应定期向团队通报项目整体进度
- 遇到问题应及时沟通，避免影响项目进度

### 8.4 执行方式
- 使用项目管理工具跟踪任务进度
- 定期召开站会，讨论每日工作进展
- 建立项目沟通群，及时沟通问题

### 8.5 违规处理
- 未按时完成任务：要求开发者说明原因，并制定改进计划
- 不参加团队会议：团队内部通报批评
- 不更新工作进度：提醒开发者及时更新

## 9. 违规处理办法

### 9.1 违规等级
- **轻微违规**：违反代码风格、提交信息格式等非核心规则
- **中度违规**：违反分支管理、测试要求等重要规则
- **严重违规**：违反开发流程、代码审查流程等核心规则
- **重复违规**：多次违反同一规则

### 9.2 处理方式
- **轻微违规**：口头提醒，要求立即整改
- **中度违规**：书面警告，要求在指定时间内整改
- **严重违规**：暂停开发权限，进行培训后恢复
- **重复违规**：团队内部通报批评，影响绩效考核

### 9.3 申诉机制
- 开发者对违规处理有异议时，可以向项目负责人提出申诉
- 项目负责人应在3个工作日内给出申诉结果

## 10. 附则

### 10.1 规则更新
- 本规则体系应定期审查和更新
- 规则更新需经团队讨论通过
- 更新后的规则应及时通知所有团队成员

### 10.2 生效日期
- 本规则体系自发布之日起生效

### 10.3 解释权
- 本规则体系的解释权归项目团队所有

---

**创建日期**：2025年12月23日
**版本**：v1.0.0